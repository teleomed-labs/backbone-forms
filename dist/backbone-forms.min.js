(function(){var a;a=Backbone.View.extend({events:{submit:function(a){this.trigger("submit",a)}},initialize:function(a){var b,c,d,e,f,g,h;h=this,a=this.options=_.extend({submitButton:!1},a),f=this.schema=function(){var b;return a.schema?_.result(a,"schema"):(b=a.model,b&&b.schema?_.result(b,"schema"):h.schema?_.result(h,"schema"):{})}(),_.extend(this,_.pick(a,"model","data","idPrefix","templateData")),b=this.constructor,this.template=a.template||this.template||b.template,this.Fieldset=a.Fieldset||this.Fieldset||b.Fieldset,this.Field=a.Field||this.Field||b.Field,this.NestedField=a.NestedField||this.NestedField||b.NestedField,g=this.selectedFields=a.fields||_.keys(f),c=this.fields={},_.each(g,function(a){var b;b=f[a],c[a]=this.createField(a,b)},this),d=a.fieldsets||_.result(this,"fieldsets")||_.result(this.model,"fieldsets")||[g],e=this.fieldsets=[],_.each(d,function(a){this.fieldsets.push(this.createFieldset(a))},this)},createFieldset:function(a){var b;return b={schema:a,fields:this.fields,legend:a.legend||null},new this.Fieldset(b)},createField:function(a,b){var c,d;return d={form:this,key:a,schema:b,idPrefix:this.idPrefix},this.model?d.model=this.model:this.data?d.value=this.data[a]:d.value=null,c=new this.Field(d),this.listenTo(c.editor,"all",this.handleEditorEvent),c},handleEditorEvent:function(a,b){var c,d;switch(c=b.key+":"+a,this.trigger.call(this,c,this,b,Array.prototype.slice.call(arguments,2)),a){case"change":this.trigger("change",this);break;case"focus":this.hasFocus||this.trigger("focus",this);break;case"blur":this.hasFocus&&(d=this,setTimeout(function(){var a;a=_.find(d.fields,function(a){return a.editor.hasFocus}),a||d.trigger("blur",d)},0))}},templateData:function(){var a;return a=this.options,{submitButton:a.submitButton}},render:function(){var a,b,c,d;return d=this,c=this.fields,a=Backbone.$,b=a(a.trim(this.template(_.result(this,"templateData")))),b.find("[data-editors]").add(b).each(function(b,e){var f,g,h;f=a(e),h=f.attr("data-editors"),_.isUndefined(h)||(g="*"===h?d.selectedFields||_.keys(c):h.split(","),_.each(g,function(a){var b;b=c[a],f.append(b.editor.render().el)}))}),b.find("[data-fields]").add(b).each(function(b,e){var f,g,h;f=a(e),h=f.attr("data-fields"),_.isUndefined(h)||(g="*"===h?d.selectedFields||_.keys(c):h.split(","),_.each(g,function(a){var b;b=c[a],f.append(b.render().el)}))}),b.find("[data-fieldsets]").add(b).each(function(b,c){var e,f;e=a(c),f=e.attr("data-fieldsets"),_.isUndefined(f)||_.each(d.fieldsets,function(a){e.append(a.render().el)})}),this.setElement(b),b.addClass(this.className),this},validate:function(a){var b,c,d,e,f,g;return g=this,c=this.fields,e=this.model,b={},a=a||{},_.each(c,function(a){var c;c=a.validate(),c&&(b[a.key]=c)}),!a.skipModelValidate&&e&&e.validate&&(f=e.validate(this.getValue()),f&&(d=_.isObject(f)&&!_.isArray(f),d||(b._others=b._others||[],b._others.push(f)),d&&_.each(f,function(a,d){var e;c[d]&&!b[d]?(c[d].setError(a),b[d]=a):(b._others=b._others||[],e={},e[d]=a,b._others.push(e))}))),_.isEmpty(b)?null:b},commit:function(a){var b,c,d,e;return a=a||{},e={skipModelValidate:!a.validate},(b=this.validate(e))?b:(c=void 0,d=_.extend({error:function(a,b){c=b}},a),this.model.set(this.getValue(),d),c?c:void 0)},getValue:function(a){var b;return a?this.fields[a].getValue():(b={},_.each(this.fields,function(a){b[a.key]=a.getValue()}),b)},setValue:function(a,b){var c,d;c={},"string"==typeof a?c[a]=b:c=a,d=void 0;for(d in this.schema)d=d,void 0!==c[d]&&this.fields[d].setValue(c[d])},getEditor:function(a){var b;if(b=this.fields[a],!b)throw new Error("Field not found: "+a);return b.editor},focus:function(){var a,b;this.hasFocus||(b=this.fieldsets[0],a=b.getFieldAt(0),a&&a.editor.focus())},blur:function(){var a;this.hasFocus&&(a=_.find(this.fields,function(a){return a.editor.hasFocus}),a&&a.editor.blur())},trigger:function(a){return"focus"===a?this.hasFocus=!0:"blur"===a&&(this.hasFocus=!1),Backbone.View.prototype.trigger.apply(this,arguments)},remove:function(){return _.each(this.fieldsets,function(a){a.remove()}),_.each(this.fields,function(a){a.remove()}),Backbone.View.prototype.remove.apply(this,arguments)}},{template:_.template('    <form>     <div data-fieldsets></div>      <% if (submitButton) { %>        <button type="submit"><%= submitButton %></button>      <% } %>    </form>  ',null,this.templateSettings),templateSettings:{evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g},editors:{}}),Backbone.Form=a,a.validators=function(){var b;return b={},b.errMessages={required:"Required",regexp:"Invalid",number:"Must be a number",email:"Invalid email address",url:"Invalid URL",match:_.template('Must match field "<%= field %>"',null,a.templateSettings)},b.required=function(a){return a=_.extend({type:"required",message:this.errMessages.required},a),function(b){var c;return a.value=b,c={type:a.type,message:_.isFunction(a.message)?a.message(a):a.message},null===b||void 0===b||b===!1||""===b?c:void 0}},b.regexp=function(a){if(!a.regexp)throw new Error('Missing required "regexp" option for "regexp" validator');return a=_.extend({type:"regexp",match:!0,message:this.errMessages.regexp},a),function(b){var c;return a.value=b,c={type:a.type,message:_.isFunction(a.message)?a.message(a):a.message},null!==b&&void 0!==b&&""!==b?("string"==typeof a.regexp&&(a.regexp=new RegExp(a.regexp,a.flags)),(a.match?!a.regexp.test(b):a.regexp.test(b))?c:void 0):void 0}},b.number=function(a){return a=_.extend({type:"number",message:this.errMessages.number,regexp:/^[0-9]*\.?[0-9]*?$/},a),b.regexp(a)},b.email=function(a){return a=_.extend({type:"email",message:this.errMessages.email,regexp:/^[\w\-]{1,}([\w\-\+.]{1,1}[\w\-]{1,}){0,}[@][\w\-]{1,}([.]([\w\-]{1,})){1,3}$/},a),b.regexp(a)},b.url=function(a){return a=_.extend({type:"url",message:this.errMessages.url,regexp:/^(http|https):\/\/(([A-Z0-9][A-Z0-9_\-]*)(\.[A-Z0-9][A-Z0-9_\-]*)+)(:(\d+))?\/?/i},a),b.regexp(a)},b.match=function(a){if(!a.field)throw new Error('Missing required "field" options for "match" validator');return a=_.extend({type:"match",message:this.errMessages.match},a),function(b,c){var d;return a.value=b,d={type:a.type,message:_.isFunction(a.message)?a.message(a):a.message},null!==b&&void 0!==b&&""!==b&&b!==c[a.field]?d:void 0}},b}(),a.Fieldset=Backbone.View.extend({initialize:function(a){var b;a=a||{},b=this.schema=this.createSchema(a.schema),this.fields=_.pick(a.fields,b.fields),this.template=a.template||b.template||this.template||this.constructor.template},createSchema:function(a){return _.isArray(a)&&(a={fields:a}),a.legend=a.legend||null,a},getFieldAt:function(a){var b;return b=this.schema.fields[a],this.fields[b]},templateData:function(){return this.schema},render:function(){var a,b,c,d;return d=this.schema,c=this.fields,a=Backbone.$,b=a(a.trim(this.template(_.result(this,"templateData")))),b.find("[data-fields]").add(b).each(function(b,d){var e,f;e=a(d),f=e.attr("data-fields"),_.isUndefined(f)||_.each(c,function(a){e.append(a.render().el)})}),this.setElement(b),this},remove:function(){_.each(this.fields,function(a){a.remove()}),Backbone.View.prototype.remove.call(this)}},{template:_.template("    <fieldset data-fields>      <% if (legend) { %>        <legend><%= legend %></legend>      <% } %>    </fieldset>  ",null,a.templateSettings)}),a.Field=Backbone.View.extend({initialize:function(a){var b;a=a||{},_.extend(this,_.pick(a,"form","key","model","value","idPrefix")),b=this.schema=this.createSchema(a.schema),this.template=a.template||b.template||this.template||this.constructor.template,this.errorClassName=a.errorClassName||this.errorClassName||this.constructor.errorClassName,this.editor=this.createEditor()},createSchema:function(b){return _.isString(b)&&(b={type:b}),b=_.extend({type:"Text",title:this.createTitle()},b),b.type=_.isString(b.type)?a.editors[b.type]:b.type,b},createEditor:function(){var a,b;return b=_.extend(_.pick(this,"schema","form","key","model","value"),{id:this.createEditorId()}),new(a=this.schema.type)(b)},createEditorId:function(){var a,b;return b=this.idPrefix,a=this.key,a=a.replace(/\./g,"_"),_.isString(b)||_.isNumber(b)?b+a:_.isNull(b)?a:this.model?this.model.cid+"_"+a:a},createTitle:function(){var a;return a=this.key,a=a.replace(/([A-Z])/g," $1"),a=a.replace(/^./,function(a){return a.toUpperCase()})},templateData:function(){var a;return a=this.schema,{help:a.help||"",title:a.title,titleHTML:a.titleHTML,fieldAttrs:a.fieldAttrs,editorAttrs:a.editorAttrs,key:this.key,editorId:this.editor.id}},render:function(){var a,b,c,d;return d=this.schema,c=this.editor,a=Backbone.$,this.editor.noField===!0?this.setElement(c.render().el):(b=a(a.trim(this.template(_.result(this,"templateData")))),d.fieldClass&&b.addClass(d.fieldClass),d.fieldAttrs&&b.attr(d.fieldAttrs),b.find("[data-editor]").add(b).each(function(b,d){var e,f;e=a(d),f=e.attr("data-editor"),_.isUndefined(f)||e.append(c.render().el)}),this.setElement(b),this)},disable:function(){var a;_.isFunction(this.editor.disable)?this.editor.disable():(a=this.editor.$el,a=a.is("input")?a:a.find("input"),a.attr("disabled",!0))},enable:function(){var a;_.isFunction(this.editor.enable)?this.editor.enable():(a=this.editor.$el,a=a.is("input")?a:a.find("input"),a.attr("disabled",!1))},validate:function(){var a;return a=this.editor.validate(),a?this.setError(a.message):this.clearError(),a},setError:function(a){this.editor.hasNestedForm||(this.$el.addClass(this.errorClassName),this.$("[data-error]").html(a))},clearError:function(){this.$el.removeClass(this.errorClassName),this.$("[data-error]").empty()},commit:function(){return this.editor.commit()},getValue:function(){return this.editor.getValue()},setValue:function(a){this.editor.setValue(a)},focus:function(){this.editor.focus()},blur:function(){this.editor.blur()},remove:function(){this.editor.remove(),Backbone.View.prototype.remove.call(this)}},{template:_.template('    <div>      <label for="<%= editorId %>">        <% if (titleHTML){ %><%= titleHTML %>        <% } else { %><%- title %><% } %>      </label>      <div>        <span data-editor></span>        <div data-error></div>        <div><%= help %></div>      </div>    </div>  ',null,a.templateSettings),errorClassName:"error"}),a.NestedField=a.Field.extend({template:_.template('    <div>      <label for="<%= editorId %>">        <% if (titleHTML){ %><%= titleHTML %>        <% } else { %><%- title %><% } %>      </label>      <div>        <span data-editor></span>        <div class="error-text" data-error></div>        <div class="error-help"><%= help %></div>      </div>    </div>  ',null,a.templateSettings)}),a.Editor=a.editors.Base=Backbone.View.extend({defaultValue:null,hasFocus:!1,initialize:function(a){var a,b;if(a=a||{},a.model){if(!a.key)throw new Error("Missing option: 'key'");this.model=a.model,this.value=this.model.get(a.key)}else void 0!==a.value&&(this.value=a.value);void 0===this.value&&(this.value=this.defaultValue),_.extend(this,_.pick(a,"key","form")),b=this.schema=a.schema||{},this.validators=a.validators||b.validators,this.$el.attr("id",this.id),this.$el.attr("name",this.getName()),b.editorClass&&this.$el.addClass(b.editorClass),b.editorAttrs&&this.$el.attr(b.editorAttrs)},getName:function(){var a;return a=this.key||"",a.replace(/\./g,"_")},getValue:function(){return this.value},setValue:function(a){this.value=a},focus:function(){throw new Error("Not implemented")},blur:function(){throw new Error("Not implemented")},commit:function(a){var b;return(b=this.validate())?b:(this.listenTo(this.model,"invalid",function(a,c){b=c}),this.model.set(this.key,this.getValue(),a),b?b:void 0)},validate:function(){var a,b,c,d,e,f;return a=this.$el,b=null,f=this.getValue(),c=this.form?this.form.getValue():{},e=this.validators,d=this.getValidator,e&&_.every(e,function(a){return b=d(a)(f,c),b?!1:!0}),b},trigger:function(a){return"focus"===a?this.hasFocus=!0:"blur"===a&&(this.hasFocus=!1),Backbone.View.prototype.trigger.apply(this,arguments)},getValidator:function(b){var c,d;if(d=a.validators,_.isRegExp(b))return d.regexp({regexp:b});if(_.isString(b)){if(!d[b])throw new Error('Validator "'+b+'" not found');return d[b]()}if(_.isFunction(b))return b;if(_.isObject(b)&&b.type)return c=b,d[c.type](c);throw new Error("Invalid validator: "+b)}}),a.editors.Text=a.Editor.extend({tagName:"input",defaultValue:"",previousValue:"",events:{keyup:"determineChange",keypress:function(a){var b;b=this,setTimeout(function(){b.determineChange()},0)},select:function(a){this.trigger("select",this)},focus:function(a){this.trigger("focus",this)},blur:function(a){this.trigger("blur",this)}},initialize:function(b){var c,d;a.editors.Base.prototype.initialize.call(this,b),c=this.schema,d="text",c&&c.editorAttrs&&c.editorAttrs.type&&(d=c.editorAttrs.type),c&&c.dataType&&(d=c.dataType),this.$el.attr("type",d)},render:function(){return this.setValue(this.value),this},determineChange:function(a){var b,c;c=this.$el.val(),b=c!==this.previousValue,b&&(this.previousValue=c,this.trigger("change",this))},getValue:function(){return this.$el.val()},setValue:function(a){this.value=a,this.$el.val(a)},focus:function(){this.hasFocus||this.$el.focus()},blur:function(){this.hasFocus&&this.$el.blur()},select:function(){this.$el.select()}}),a.editors.TextArea=a.editors.Text.extend({tagName:"textarea",initialize:function(b){a.editors.Base.prototype.initialize.call(this,b)}}),a.editors.Password=a.editors.Text.extend({initialize:function(b){a.editors.Text.prototype.initialize.call(this,b),this.$el.attr("type","password")}}),a.editors.Number=a.editors.Text.extend({defaultValue:0,events:_.extend({},a.editors.Text.prototype.events,{keypress:"onKeyPress",change:"onKeyPress"}),initialize:function(b){var c;a.editors.Text.prototype.initialize.call(this,b),c=this.schema,this.$el.attr("type","number"),c&&c.editorAttrs&&c.editorAttrs.step||this.$el.attr("step","any")},onKeyPress:function(a){var b,c,d,e;return e=this,b=function(){setTimeout(function(){e.determineChange()},0)},0===a.charCode?void b():(c=this.$el.val(),void 0!==a.charCode&&(c+=String.fromCharCode(a.charCode)),d=/^[0-9]*\.?[0-9]*?$/.test(c),void(d?b():a.preventDefault()))},getValue:function(){var a;return a=this.$el.val(),""===a?null:parseFloat(a,10)},setValue:function(b){b=function(){return _.isNumber(b)?b:_.isString(b)&&""!==b?parseFloat(b,10):null}(),_.isNaN(b)&&(b=null),this.value=b,a.editors.Text.prototype.setValue.call(this,b)}}),a.editors.Hidden=a.editors.Text.extend({defaultValue:"",noField:!0,initialize:function(b){a.editors.Text.prototype.initialize.call(this,b),this.$el.attr("type","hidden")},focus:function(){},blur:function(){}}),a.editors.Checkbox=a.editors.Base.extend({defaultValue:!1,tagName:"input",events:{click:function(a){this.trigger("change",this)},focus:function(a){this.trigger("focus",this)},blur:function(a){this.trigger("blur",this)}},initialize:function(b){a.editors.Base.prototype.initialize.call(this,b),this.$el.attr("type","checkbox")},render:function(){return this.setValue(this.value),this},getValue:function(){return this.$el.prop("checked")},setValue:function(a){a?this.$el.prop("checked",!0):this.$el.prop("checked",!1),this.value=!!a},focus:function(){this.hasFocus||this.$el.focus()},blur:function(){this.hasFocus&&this.$el.blur()}}),a.editors.Select=a.editors.Base.extend({tagName:"select",previousValue:"",events:{keyup:"determineChange",keypress:function(a){var b;b=this,setTimeout(function(){b.determineChange()},0)},change:function(a){this.trigger("change",this)},focus:function(a){this.trigger("focus",this)},blur:function(a){this.trigger("blur",this)}},initialize:function(b){if(a.editors.Base.prototype.initialize.call(this,b),!this.schema||!this.schema.options)throw new Error("Missing required 'schema.options'")},render:function(){return this.setOptions(this.schema.options),this},setOptions:function(a){var b,c;c=this,a instanceof Backbone.Collection?(b=a,b.length>0?this.renderOptions(a):b.fetch({success:function(b){c.renderOptions(a)}})):_.isFunction(a)?a(function(a){c.renderOptions(a)},c):this.renderOptions(a)},renderOptions:function(a){var b,c;b=this.$el,c=void 0,c=this._getOptionsHtml(a),b.html(c),this.setValue(this.value)},_getOptionsHtml:function(a){var b,c;return b=void 0,_.isString(a)?b=a:_.isArray(a)?b=this._arrayToHtml(a):a instanceof Backbone.Collection?b=this._collectionToHtml(a):_.isFunction(a)?(c=void 0,a(function(a){c=a},this),b=this._getOptionsHtml(c)):b=this._objectToHtml(a),b},determineChange:function(a){var b,c;c=this.getValue(),b=c!==this.previousValue,b&&(this.previousValue=c,this.trigger("change",this))},getValue:function(){return this.$el.val()},setValue:function(a){this.value=a,this.$el.val(a)},focus:function(){this.hasFocus||this.$el.focus()},blur:function(){this.hasFocus&&this.$el.blur()},_collectionToHtml:function(a){var b,c;return b=[],a.each(function(a){b.push({val:a.id,label:a.toString()})}),c=this._arrayToHtml(b)},_objectToHtml:function(a){var b,c,d;b=[];for(d in a)a.hasOwnProperty(d)&&b.push({val:d,label:a[d]});return c=this._arrayToHtml(b)},_arrayToHtml:function(a){var b;return b=$(),_.each(a,function(a){var c,d;_.isObject(a)?a.group?(c=$("<optgroup>").attr("label",a.group).html(this._getOptionsHtml(a.options)),b=b.add(c)):(d=a.val||0===a.val?a.val:"",b=b.add($("<option>").val(d).text(a.label))):b=b.add($("<option>").text(a))},this),b}}),a.editors.Radio=a.editors.Select.extend({tagName:"ul",events:{"change input[type=radio]":function(){this.trigger("change",this)},"focus input[type=radio]":function(){this.hasFocus||this.trigger("focus",this)},"blur input[type=radio]":function(){var a;this.hasFocus&&(a=this,setTimeout(function(){a.$("input[type=radio]:focus")[0]||a.trigger("blur",a)},0))}},getTemplate:function(){return this.schema.template||this.constructor.template},getValue:function(){return this.$("input[type=radio]:checked").val()},setValue:function(a){this.value=a,this.$("input[type=radio]").val([a])},focus:function(){var a;if(!this.hasFocus)return a=this.$("input[type=radio]:checked"),a[0]?void a.focus():void this.$("input[type=radio]").first().focus()},blur:function(){this.hasFocus&&this.$("input[type=radio]:focus").blur()},_arrayToHtml:function(a){var b,c,d,e,f;return e=this,f=this.getTemplate(),d=e.getName(),b=e.id,c=_.map(a,function(a,c){var e;return e={name:d,id:b+"-"+c},_.isObject(a)?(e.value=a.val||0===a.val?a.val:"",e.label=a.label,e.labelHTML=a.labelHTML):(e.value=a,e.label=a),e}),f({items:c})}},{template:_.template('    <% _.each(items, function(item) { %>      <li>        <input type="radio" name="<%= item.name %>" value="<%- item.value %>" id="<%= item.id %>" />        <label for="<%= item.id %>"><% if (item.labelHTML){ %><%= item.labelHTML %><% }else{ %><%- item.label %><% } %></label>      </li>    <% }); %>  ',null,a.templateSettings)}),a.editors.Checkboxes=a.editors.Select.extend({tagName:"ul",groupNumber:0,events:{"click input[type=checkbox]":function(){this.trigger("change",this)},"focus input[type=checkbox]":function(){this.hasFocus||this.trigger("focus",this)},"blur input[type=checkbox]":function(){var a;this.hasFocus&&(a=this,setTimeout(function(){a.$("input[type=checkbox]:focus")[0]||a.trigger("blur",a)},0))}},getValue:function(){var a;return a=[],this.$("input[type=checkbox]:checked").each(function(){a.push($(this).val())}),a},setValue:function(a){_.isArray(a)||(a=[a]),this.value=a,this.$("input[type=checkbox]").val(a)},focus:function(){this.hasFocus||this.$("input[type=checkbox]").first().focus()},blur:function(){this.hasFocus&&this.$("input[type=checkbox]:focus").blur()},_arrayToHtml:function(a){var b,c;return b=$(),c=this,_.each(a,function(a,d){var e,f,g,h;f=$("<li>"),_.isObject(a)?a.group?(g=c.id,c.id+="-"+c.groupNumber++,f=$('<fieldset class="group">').append($("<legend>").text(a.group)),f=f.append(c._arrayToHtml(a.options)),c.id=g,e=!1):(h=a.val||0===a.val?a.val:"",f.append($('<input type="checkbox" name="'+c.getName()+'" id="'+c.id+"-"+d+'" />').val(h)),a.labelHTML?f.append($('<label for="'+c.id+"-"+d+'">').html(a.labelHTML)):f.append($('<label for="'+c.id+"-"+d+'">').text(a.label))):(f.append($('<input type="checkbox" name="'+c.getName()+'" id="'+c.id+"-"+d+'" />').val(a)),f.append($('<label for="'+c.id+"-"+d+'">').text(a))),b=b.add(f)}),b}}),a.editors.Object=a.editors.Base.extend({hasNestedForm:!0,initialize:function(b){if(this.value={},a.editors.Base.prototype.initialize.call(this,b),!this.form)throw new Error('Missing required option "form"');if(!this.schema.subSchema)throw new Error("Missing required 'schema.subSchema' option for Object editor")},render:function(){var a;return a=this.form.constructor,this.nestedForm=new a({schema:this.schema.subSchema,data:this.value,idPrefix:this.id+"_",Field:a.NestedField}),this._observeFormEvents(),this.$el.html(this.nestedForm.render().el),this.hasFocus&&this.trigger("blur",this),this},getValue:function(){return this.nestedForm?this.nestedForm.getValue():this.value},setValue:function(a){this.value=a,this.render()},focus:function(){this.hasFocus||this.nestedForm.focus()},blur:function(){this.hasFocus&&this.nestedForm.blur()},remove:function(){this.nestedForm.remove(),Backbone.View.prototype.remove.call(this)},validate:function(){var b;return b=_.extend({},a.editors.Base.prototype.validate.call(this),this.nestedForm.validate()),_.isEmpty(b)?!1:b},_observeFormEvents:function(){this.nestedForm&&this.nestedForm.on("all",function(){var a;a=_.toArray(arguments),a[1]=this,this.trigger.apply(this,a)},this)}}),a.editors.NestedModel=a.editors.Object.extend({initialize:function(b){if(a.editors.Base.prototype.initialize.call(this,b),!this.form)throw new Error('Missing required option "form"');if(!b.schema.model)throw new Error('Missing required "schema.model" option for NestedModel editor')},render:function(){var a,b,c,d,e;return a=this.form.constructor,b=this.value||{},c=this.key,e=this.schema.model,d=b.constructor===e?b:new e(b),this.nestedForm=new a({model:d,idPrefix:this.id+"_",fieldTemplate:"nestedField"}),this._observeFormEvents(),this.$el.html(this.nestedForm.render().el),this.hasFocus&&this.trigger("blur",this),this},commit:function(){var b;return b=this.nestedForm.commit(),b?(this.$el.addClass("error"),b):a.editors.Object.prototype.commit.call(this)}}),a.editors.Date=a.editors.Base.extend({events:{"change select":function(){this.updateHidden(),this.trigger("change",this)},"focus select":function(){this.hasFocus||this.trigger("focus",this)},"blur select":function(){var a;this.hasFocus&&(a=this,setTimeout(function(){a.$("select:focus")[0]||a.trigger("blur",a)},0))}},initialize:function(b){var c,d,e;b=b||{},a.editors.Base.prototype.initialize.call(this,b),c=a.editors.Date,e=new Date,this.options=_.extend({monthNames:c.monthNames,showMonthNames:c.showMonthNames},b),this.schema=_.extend({yearStart:e.getFullYear()-100,yearEnd:e.getFullYear()},b.schema||{}),this.value&&!_.isDate(this.value)&&(this.value=new Date(this.value)),this.value||(d=new Date,d.setSeconds(0),d.setMilliseconds(0),this.value=d),this.template=b.template||this.constructor.template},render:function(){var a,b,c,d,e,f,g,h;return e=this.options,f=this.schema,a=Backbone.$,c=_.map(_.range(1,32),function(a){return'<option value="'+a+'">'+a+"</option>"}),d=_.map(_.range(0,12),function(a){var b;return b=e.showMonthNames?e.monthNames[a]:a+1,'<option value="'+a+'">'+b+"</option>"}),g=f.yearStart<f.yearEnd?_.range(f.yearStart,f.yearEnd+1):_.range(f.yearStart,f.yearEnd-1,-1),h=_.map(g,function(a){return'<option value="'+a+'">'+a+"</option>"}),b=a(a.trim(this.template({dates:c.join(""),months:d.join(""),years:h.join("")}))),this.$date=b.find('[data-type="date"]'),this.$month=b.find('[data-type="month"]'),this.$year=b.find('[data-type="year"]'),this.$hidden=a('<input type="hidden" name="'+this.key+'" />'),b.append(this.$hidden),this.setValue(this.value),this.setElement(b),this.$el.attr("id",this.id),this.$el.attr("name",this.getName()),this.hasFocus&&this.trigger("blur",this),this},getValue:function(){var a,b,c;return c=this.$year.val(),b=this.$month.val(),a=this.$date.val(),c&&b&&a?new Date(c,b,a):null},setValue:function(a){this.value=a,this.$date.val(a.getDate()),this.$month.val(a.getMonth()),this.$year.val(a.getFullYear()),this.updateHidden()},focus:function(){this.hasFocus||this.$("select").first().focus()},blur:function(){this.hasFocus&&this.$("select:focus").blur()},updateHidden:function(){var a;a=this.getValue(),_.isDate(a)&&(a=a.toISOString()),this.$hidden.val(a)}},{template:_.template('    <div>      <select data-type="date"><%= dates %></select>      <select data-type="month"><%= months %></select>      <select data-type="year"><%= years %></select>    </div>  ',null,a.templateSettings),showMonthNames:!0,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"]}),a.editors.DateTime=a.editors.Base.extend({events:{"change select":function(){this.updateHidden(),this.trigger("change",this)},"focus select":function(){this.hasFocus||this.trigger("focus",this)},"blur select":function(){var a;this.hasFocus&&(a=this,setTimeout(function(){a.$("select:focus")[0]||a.trigger("blur",a)},0))}},initialize:function(b){b=b||{},a.editors.Base.prototype.initialize.call(this,b),this.options=_.extend({DateEditor:a.editors.DateTime.DateEditor},b),this.schema=_.extend({minsInterval:15},b.schema||{}),this.dateEditor=new this.options.DateEditor(b),this.value=this.dateEditor.value,this.template=b.template||this.constructor.template},render:function(){var a,b,c,d,e,f;return e=function(a){return 10>a?"0"+a:a},f=this.schema,a=Backbone.$,c=_.map(_.range(0,24),function(a){return'<option value="'+a+'">'+e(a)+"</option>"}),d=_.map(_.range(0,60,f.minsInterval),function(a){return'<option value="'+a+'">'+e(a)+"</option>"}),b=a(a.trim(this.template({hours:c.join(),mins:d.join()}))),b.find("[data-date]").append(this.dateEditor.render().el),this.$hour=b.find('select[data-type="hour"]'),this.$min=b.find('select[data-type="min"]'),this.$hidden=b.find('input[type="hidden"]'),this.setValue(this.value),this.setElement(b),this.$el.attr("id",this.id),this.$el.attr("name",this.getName()),this.hasFocus&&this.trigger("blur",this),this},getValue:function(){var a,b,c;return a=this.dateEditor.getValue(),b=this.$hour.val(),c=this.$min.val(),a&&b&&c?(a.setHours(b),a.setMinutes(c),a):null},setValue:function(a){_.isDate(a)||(a=new Date(a)),this.value=a,this.dateEditor.setValue(a),this.$hour.val(a.getHours()),this.$min.val(a.getMinutes()),this.updateHidden()},focus:function(){this.hasFocus||this.$("select").first().focus()},blur:function(){this.hasFocus&&this.$("select:focus").blur()},updateHidden:function(){var a;a=this.getValue(),_.isDate(a)&&(a=a.toISOString()),this.$hidden.val(a)},remove:function(){this.dateEditor.remove(),a.editors.Base.prototype.remove.call(this)}},{template:_.template('    <div class="bbf-datetime">      <div class="bbf-date-container" data-date></div>      <select data-type="hour"><%= hours %></select>      :      <select data-type="min"><%= mins %></select>    </div>  ',null,a.templateSettings),DateEditor:a.editors.Date}),function(a){a.editors.List=a.editors.Base.extend({events:{'click [data-action="add"]':function(a){a.preventDefault(),this.addItem(null,!0)}},initialize:function(b){var c,d;if(b=b||{},c=a.editors,c.Base.prototype.initialize.call(this,b),d=this.schema,!d)throw new Error("Missing required option 'schema'");this.template=b.template||d.listTemplate||this.constructor.template,this.Editor=function(){var a;return a=d.itemType,a?c.List[a]?c.List[a]:c[a]:c.Text}(),this.items=[]},render:function(){var a,b,c,d;return c=this,d=this.value||[],a=Backbone.$,b=a(a.trim(this.template())),this.$list=b.is("[data-items]")?b:b.find("[data-items]"),d.length?_.each(d,function(a){c.addItem(a)}):this.Editor.isAsync||this.addItem(),this.setElement(b),this.$el.attr("id",this.id),this.$el.attr("name",this.key),this.hasFocus&&this.trigger("blur",this),this},addItem:function(b,c){var d,e,f,g;return g=this,e=a.editors,f=new e.List.Item({list:this,form:this.form,schema:this.schema,value:b,Editor:this.Editor,key:this.key}).render(),d=function(){g.items.push(f),g.$list.append(f.el),f.editor.on("all",function(a){var b;"change"!==a&&(b=_.toArray(arguments),b[0]="item:"+a,b.splice(1,0,g),e.List.prototype.trigger.apply(this,b))},g),f.editor.on("change",function(){f.addEventTriggered||(f.addEventTriggered=!0,this.trigger("add",this,f.editor)),this.trigger("item:change",this,f.editor),this.trigger("change",this)},g),f.editor.on("focus",function(){this.hasFocus||this.trigger("focus",this)},g),f.editor.on("blur",function(){var a;this.hasFocus&&(a=this,setTimeout(function(){_.find(a.items,function(a){return a.editor.hasFocus})||a.trigger("blur",a)},0))},g),(c||b)&&(f.addEventTriggered=!0),c&&(g.trigger("add",g,f.editor),g.trigger("change",g))},this.Editor.isAsync?f.editor.on("readyToAdd",d,this):(d(),f.editor.focus()),f},removeItem:function(a){var b,c;b=this.schema.confirmDelete,(!b||confirm(b))&&(c=_.indexOf(this.items,a),this.items[c].remove(),this.items.splice(c,1),a.addEventTriggered&&(this.trigger("remove",this,a.editor),this.trigger("change",this)),this.items.length||this.Editor.isAsync||this.addItem())},getValue:function(){var a;return a=_.map(this.items,function(a){return a.getValue()}),_.without(a,void 0,"")},setValue:function(a){this.value=a,this.render()},focus:function(){this.hasFocus||this.items[0]&&this.items[0].editor.focus()},blur:function(){var a;this.hasFocus&&(a=_.find(this.items,function(a){return a.editor.hasFocus}),a&&a.editor.blur())},remove:function(){_.invoke(this.items,"remove"),a.editors.Base.prototype.remove.call(this)},validate:function(){var a,b,c;return this.validators?(a=_.map(this.items,function(a){return a.validate()}),(c=_.compact(a).length?!0:!1)?b={type:"list",message:"Some of the items in the list failed validation",errors:a}:null):null}},{template:_.template('      <div>        <div data-items></div>        <button type="button" data-action="add">Add</button>      </div>    ',null,a.templateSettings)}),a.editors.List.Item=a.editors.Base.extend({events:{'click [data-action="remove"]':function(a){a.preventDefault(),this.list.removeItem(this)},"keydown input[type=text]":function(a){13===a.keyCode&&(a.preventDefault(),this.list.addItem(),this.list.$list.find("> li:last input").focus())}},initialize:function(b){this.list=b.list,this.schema=b.schema||this.list.schema,this.value=b.value,this.Editor=b.Editor||a.editors.Text,this.key=b.key,this.template=b.template||this.schema.itemTemplate||this.constructor.template,this.errorClassName=b.errorClassName||this.constructor.errorClassName,this.form=b.form},render:function(){var a,b;return a=Backbone.$,this.editor=new this.Editor({key:this.key,schema:this.schema,value:this.value,list:this.list,item:this,form:this.form}).render(),b=a(a.trim(this.template())),b.find("[data-editor]").append(this.editor.el),this.setElement(b),this},getValue:function(){return this.editor.getValue()},setValue:function(a){this.editor.setValue(a)},focus:function(){this.editor.focus()},blur:function(){this.editor.blur()},remove:function(){this.editor.remove(),Backbone.View.prototype.remove.call(this)},validate:function(){var a,b,c,d,e;return e=this.getValue(),b=this.list.form?this.list.form.getValue():{},d=this.schema.validators,c=this.getValidator,d?(a=null,_.every(d,function(d){return a=c(d)(e,b),a?!1:!0}),a?this.setError(a):this.clearError(),a?a:null):null},setError:function(a){this.$el.addClass(this.errorClassName),this.$el.attr("title",a.message)},clearError:function(){this.$el.removeClass(this.errorClassName),this.$el.attr("title",null)}},{template:_.template('      <div>        <span data-editor></span>        <button type="button" data-action="remove">&times;</button>      </div>    ',null,a.templateSettings),errorClassName:"error"}),a.editors.List.Modal=a.editors.Base.extend({events:{click:"openEditor"},initialize:function(b){if(b=b||{},a.editors.Base.prototype.initialize.call(this,b),!a.editors.List.Modal.ModalAdapter)throw new Error("A ModalAdapter is required");
if(this.form=b.form,!b.form)throw new Error('Missing required option: "form"');this.template=b.template||this.constructor.template},render:function(){var a;return a=this,_.isEmpty(this.value)?this.openEditor():(this.renderSummary(),setTimeout(function(){a.trigger("readyToAdd")},0)),this.hasFocus&&this.trigger("blur",this),this},renderSummary:function(){this.$el.html($.trim(this.template({summary:this.getStringValue()})))},itemToString:function(b){var c,d;return c=function(b){var c;return c={key:b},a.Field.prototype.createTitle.call(c)},b=b||{},d=[],_.each(this.nestedSchema,function(a,e){var f,g;f=a.title?a.title:c(e),g=b[e],(_.isUndefined(g)||_.isNull(g))&&(g=""),d.push(f+": "+g)}),d.join("<br />")},getStringValue:function(){var a,b;return a=this.schema,b=this.getValue(),_.isEmpty(b)?"[Empty]":a.itemToString?a.itemToString(b):this.itemToString(b)},openEditor:function(){var b,c,d,e;e=this,b=this.form.constructor,c=this.modalForm=new b({schema:this.nestedSchema,data:this.value}),d=this.modal=new a.editors.List.Modal.ModalAdapter({content:c,animate:!0}),d.open(),this.trigger("open",this),this.trigger("focus",this),d.on("cancel",this.onModalClosed,this),d.on("ok",_.bind(this.onModalSubmitted,this))},onModalSubmitted:function(){var a,b,c,d;return d=this.modal,b=this.modalForm,c=!this.value,(a=b.validate())?d.preventClose():(this.value=b.getValue(),this.renderSummary(),c&&this.trigger("readyToAdd"),this.trigger("change",this),void this.onModalClosed())},onModalClosed:function(){this.modal=null,this.modalForm=null,this.trigger("close",this),this.trigger("blur",this)},getValue:function(){return this.value},setValue:function(a){this.value=a},focus:function(){this.hasFocus||this.openEditor()},blur:function(){this.hasFocus&&this.modal&&this.modal.trigger("cancel")}},{template:_.template("      <div><%= summary %></div>    ",null,a.templateSettings),ModalAdapter:Backbone.BootstrapModal,isAsync:!0}),a.editors.List.Object=a.editors.List.Modal.extend({initialize:function(){var b;if(a.editors.List.Modal.prototype.initialize.apply(this,arguments),b=this.schema,!b.subSchema)throw new Error('Missing required option "schema.subSchema"');this.nestedSchema=b.subSchema}}),a.editors.List.NestedModel=a.editors.List.Modal.extend({initialize:function(){var b,c;if(a.editors.List.Modal.prototype.initialize.apply(this,arguments),c=this.schema,!c.model)throw new Error('Missing required option "schema.model"');b=c.model.prototype.schema,this.nestedSchema=_.isFunction(b)?b():b},getStringValue:function(){var a,b;return a=this.schema,b=this.getValue(),_.isEmpty(b)?null:a.itemToString?a.itemToString(b):new a.model(b).toString()}})}(Backbone.Form)}).call(this);